// ===== Unsplash API ì„¤ì • =====
const UNSPLASH_ACCESS_KEY = 'Id8OlS5V38OdwbDrUvNzBmnTao4U6dyPbOPyZwcNtAI';

const EXCHANGERATE_API_URL = 'https://api.exchangerate-api.com/v4/latest/KRW';

// ì¶•ì œ ìœ„ì¹˜ ë° í†µí™” ì •ë³´
const festivalLocationInfo = {
    tomatina: { countryCode: 'es', currency: 'EUR', currencySymbol: 'â‚¬' },
    oktoberfest: { countryCode: 'de', currency: 'EUR', currencySymbol: 'â‚¬' },
    carnival: { countryCode: 'br', currency: 'BRL', currencySymbol: 'R$' }
};

// ë‚ ì”¨ ì •ë³´ (Mock)
const mockWeatherData = {
    tomatina: { temp: 28, icon: 'â˜€ï¸', description: 'ë§‘ìŒ' },
    oktoberfest: { temp: 18, icon: 'â›…', description: 'êµ¬ë¦„ ì¡°ê¸ˆ' },
    carnival: { temp: 32, icon: 'ğŸŒ¤ï¸', description: 'í™”ì°½í•¨' }
};
// ===== ì¶•ì œ ë°ì´í„° ì •ì˜ =====
const festivalsData = {
    tomatina: {
        id: 'tomatina',
        countryCode: "es",
        name: 'ë¼ í† ë§ˆí‹°ë‚˜',
        location: 'ìŠ¤í˜ì¸ ë°œë Œì‹œì•„ ë¶€ë‡°',
        period: 'ë§¤ë…„ 8ì›” ë§ˆì§€ë§‰ ìˆ˜ìš”ì¼',
        duration: '5ì¼',
        price: 'â‚©2,200,000',
        target: '20-30ëŒ€ ì Šì€ ì—¬í–‰ê°',
        description: 'ì„¸ê³„ì—ì„œ ê°€ì¥ í° í† ë§ˆí†  ì¶•ì œ! ìˆ˜ë§Œ ëª…ì´ ê±°ë¦¬ì—ì„œ í† ë§ˆí† ë¥¼ ë˜ì§€ë©° ì¦ê¸°ëŠ” ë…íŠ¹í•œ ìŠ¤í˜ì¸ ì „í†µ ì¶•ì œì…ë‹ˆë‹¤.',
        mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3078.7285894982576!2d-0.7889!3d39.4167!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0xd604f4cf0efb06f%3A0x40640856e73be20!2sBu%C3%B1ol%2C%20Valencia%2C%20Spain!5e0!3m2!1sen!2skr!4v1234567890',
        imageQuery: 'la tomatina festival spain',
        fallbackImage: 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=800',
        attractions: [
            {
                name: 'ë¼ í† ë§ˆí‹°ë‚˜ ì¶•ì œ',
                description: 'ìˆ˜ë§Œ ëª…ì´ ì°¸ê°€í•˜ëŠ” í† ë§ˆí†  ë˜ì§€ê¸° ì¶•ì œ',
                image: 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=600'
            },
            {
                name: 'ë°œë Œì‹œì•„ êµ¬ì‹œê°€ì§€',
                description: 'ì¤‘ì„¸ ì‹œëŒ€ ê±´ì¶•ë¬¼ê³¼ ì„±ë‹¹',
                image: 'https://images.unsplash.com/photo-1562883676-8c7feb83f09b?w=600'
            },
            {
                name: 'ì•Œë¶€í˜ë¼ êµ­ë¦½ê³µì›',
                description: 'ì•„ë¦„ë‹¤ìš´ ì„í˜¸ì™€ ìŒ€ ì¬ë°° ì§€ì—­',
                image: 'https://images.unsplash.com/photo-1523531294919-4bcd7c65e216?w=600'
            }
        ],
        budget: {
            'í•­ê³µê¶Œ': 800000,
            'ìˆ™ë°•': 500000,
            'ì‹ì‚¬': 400000,
            'ì…ì¥ë£Œ': 200000,
            'êµí†µ': 200000,
            'ê¸°íƒ€': 100000
        },
        tips: {
            ì¤€ë¹„ë¬¼: ['ì˜¤ë˜ëœ ì˜·', 'ê³ ê¸€', 'ë°©ìˆ˜ ì‹ ë°œ', 'ìˆ˜ê±´'],
            ì£¼ì˜ì‚¬í•­: ['ê·€ì¤‘í’ˆì€ í˜¸í…”ì— ë³´ê´€', 'í† ë§ˆí† ê°€ ëˆˆì— ë“¤ì–´ê°€ì§€ ì•Šë„ë¡ ì£¼ì˜', 'ì¶•ì œ í›„ ìƒ¤ì›Œ ì‹œì„¤ ì´ìš©'],
            ì¶”ì²œ: ['ì¶•ì œ ì „ë‚  ë¶€ë‡° ë„ì°©', 'íŒŒì—ì•¼ ë§›ë³´ê¸°', 'ë°œë Œì‹œì•„ í•´ë³€ ë°©ë¬¸']
        },
        packageDetails: {
            included: [
                'ì™•ë³µ í•­ê³µê¶Œ (ì¸ì²œ-ë§ˆë“œë¦¬ë“œ-ë°œë Œì‹œì•„, ì´ì½”ë…¸ë¯¸ì„)',
                '4ì„±ê¸‰ í˜¸í…” 4ë°• (ì¡°ì‹ í¬í•¨)',
                'ë¼ í† ë§ˆí‹°ë‚˜ ì…ì¥ê¶Œ ë° ì°¸ê°€ë³µ',
                'ë°œë Œì‹œì•„ ì‹œë‚´ ê°€ì´ë“œ íˆ¬ì–´',
                'ì•Œë¶€í˜ë¼ êµ­ë¦½ê³µì› íˆ¬ì–´',
                'ì—¬í–‰ì ë³´í—˜',
                'í•œêµ­ì¸ ê°€ì´ë“œ',
                'ê³µí•­-í˜¸í…” ì™•ë³µ ì…”í‹€'
            ],
            excluded: [
                'ê°œì¸ ê²½ë¹„ ë° ì‡¼í•‘ ë¹„ìš©',
                'ì„ íƒ ê´€ê´‘ í”„ë¡œê·¸ë¨',
                'ì ì‹¬/ì €ë… ì‹ì‚¬',
                'í˜¸í…” ë¯¸ë‹ˆë°”',
                'ì—¬ê¶Œ ë°œê¸‰ ë¹„ìš©'
            ],
            productCode: 'FEST-ES-001',
            departureDates: [
                '2025ë…„ 8ì›” 23ì¼ (í† )',
                '2025ë…„ 8ì›” 24ì¼ (ì¼)',
                '2025ë…„ 8ì›” 25ì¼ (ì›”)'
            ],
            groupDiscount: {
                '4-6ëª…': '1ì¸ë‹¹ 30,000ì› í• ì¸',
                '7-9ëª…': '1ì¸ë‹¹ 50,000ì› í• ì¸',
                '10ëª… ì´ìƒ': '1ì¸ë‹¹ 80,000ì› í• ì¸'
            }
        }
    },
    oktoberfest: {
        id: 'oktoberfest',
        countryCode: "de",
        name: 'ì˜¥í† ë²„í˜ìŠ¤íŠ¸',
        location: 'ë…ì¼ ë®Œí—¨',
        period: '9ì›” ë§ - 10ì›” ì´ˆ (ì•½ 16-18ì¼)',
        duration: '6ì¼',
        price: 'â‚©2,800,000',
        target: '30ëŒ€ ì´ìƒ ì„±ì¸',
        description: 'ì„¸ê³„ ìµœëŒ€ ë§¥ì£¼ ì¶•ì œ! ì „í†µ ì˜ìƒì„ ì…ê³  ê±°ëŒ€í•œ í…íŠ¸ì—ì„œ ë§¥ì£¼ì™€ ìŒì‹ì„ ì¦ê¸°ëŠ” ë…ì¼ì˜ ëŒ€í‘œ ì¶•ì œì…ë‹ˆë‹¤.',
        mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2662.7285894982576!2d11.5497!3d48.1316!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x479e75f9a38c5fd9%3A0x10cb84a7db1987d!2sTheresienwiese%2C%20Munich%2C%20Germany!5e0!3m2!1sen!2skr!4v1234567890',
        imageQuery: 'oktoberfest munich germany',
        fallbackImage: 'https://images.unsplash.com/photo-1516997121675-4c2d1684aa3e?w=800',
        attractions: [
            {
                name: 'ì˜¥í† ë²„í˜ìŠ¤íŠ¸ ë©”ì¸ í…íŠ¸',
                description: 'ì „í†µ ë§¥ì£¼ì™€ ë°”ì´ì—ë¥¸ ìŒì‹',
                image: 'https://images.unsplash.com/photo-1516997121675-4c2d1684aa3e?w=600'
            },
            {
                name: 'ë…¸ì´ìŠˆë°˜ìŠˆíƒ€ì¸ ì„±',
                description: 'ë™í™” ì† ì„±ì˜ ëª¨ë¸',
                image: 'https://images.unsplash.com/photo-1467269204594-9661b134dd2b?w=600'
            },
            {
                name: 'ë§ˆë¦¬ì—” ê´‘ì¥',
                description: 'ë®Œí—¨ êµ¬ì‹œê°€ì§€ ì¤‘ì‹¬',
                image: 'https://images.unsplash.com/photo-1595867818082-083862f3d630?w=600'
            }
        ],
        budget: {
            'í•­ê³µê¶Œ': 1000000,
            'ìˆ™ë°•': 700000,
            'ì‹ì‚¬': 500000,
            'ì…ì¥ë£Œ': 300000,
            'êµí†µ': 200000,
            'ê¸°íƒ€': 100000
        },
        tips: {
            ì¤€ë¹„ë¬¼: ['ì „í†µ ì˜ìƒ (ë””ë¥¸ë“¤/ë ˆë”í˜¸ì  )', 'í¸í•œ ì‹ ë°œ', 'í° ê°€ë°©'],
            ì£¼ì˜ì‚¬í•­: ['í…íŠ¸ ì˜ˆì•½ í•„ìˆ˜', 'í˜„ê¸ˆ ì¤€ë¹„', 'ê³¼ìŒ ì£¼ì˜'],
            ì¶”ì²œ: ['ì•„ì¹¨ ì¼ì° ë°©ë¬¸', 'ì „í†µ ì˜ìƒ ëŒ€ì—¬', 'ì£¼ë³€ ë„ì‹œ ë°©ë¬¸']
        },
        packageDetails: {
            included: [
                'ì™•ë³µ í•­ê³µê¶Œ (ì¸ì²œ-ë®Œí—¨, ì´ì½”ë…¸ë¯¸ì„)',
                '5ì„±ê¸‰ í˜¸í…” 5ë°• (ì¡°ì‹ í¬í•¨)',
                'ì˜¥í† ë²„í˜ìŠ¤íŠ¸ ì…ì¥ê¶Œ 2íšŒ',
                'ë§¥ì£¼ í…íŠ¸ ì˜ˆì•½ì„ & ë§¥ì£¼ 2ë¦¬í„° ì¿ í°',
                'ë®Œí—¨ ì‹œë‚´ ê°€ì´ë“œ íˆ¬ì–´',
                'ë…¸ì´ìŠˆë°˜ìŠˆíƒ€ì¸ ì„± ë‹¹ì¼ íˆ¬ì–´',
                'ì—¬í–‰ì ë³´í—˜',
                'í•œêµ­ì¸ ê°€ì´ë“œ'
            ],
            excluded: [
                'ê°œì¸ ê²½ë¹„ ë° ì‡¼í•‘ ë¹„ìš©',
                'ì„ íƒ ê´€ê´‘ í”„ë¡œê·¸ë¨',
                'ì¶”ê°€ ë§¥ì£¼ ë° ì‹ì‚¬',
                'í˜¸í…” ë¯¸ë‹ˆë°” ë° ë£¸ì„œë¹„ìŠ¤',
                'ì—¬ê¶Œ ë°œê¸‰ ë¹„ìš©'
            ],
            productCode: 'FEST-DE-002',
            departureDates: [
                '2025ë…„ 9ì›” 18ì¼ (ëª©)',
                '2025ë…„ 9ì›” 25ì¼ (ëª©)',
                '2025ë…„ 10ì›” 2ì¼ (ëª©)'
            ],
            groupDiscount: {
                '4-6ëª…': '1ì¸ë‹¹ 50,000ì› í• ì¸',
                '7-9ëª…': '1ì¸ë‹¹ 80,000ì› í• ì¸',
                '10ëª… ì´ìƒ': '1ì¸ë‹¹ 100,000ì› í• ì¸'
            }
        }
    },
    carnival: {
        id: 'carnival',
        countryCode: "br",
        name: 'ë¦¬ìš° ì¹´ë‹ˆë°œ',
        location: 'ë¸Œë¼ì§ˆ ë¦¬ìš°ë°ìë„¤ì´ë£¨',
        period: 'ë§¤ë…„ 2ì›” (ì‚¬ìˆœì ˆ ì‹œì‘ ì „)',
        duration: '7ì¼',
        price: 'â‚©3,500,000',
        target: 'ì „ ì—°ë ¹',
        description: 'ì„¸ê³„ ìµœëŒ€ ê·œëª¨ì˜ ì¹´ë‹ˆë°œ! í™”ë ¤í•œ ì‚¼ë°” í¼ë ˆì´ë“œì™€ ê±°ë¦¬ ì¶•ì œê°€ í¼ì³ì§€ëŠ” ë¸Œë¼ì§ˆì˜ ëŒ€í‘œ ì¶•ì œì…ë‹ˆë‹¤.',
        mapUrl: 'https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3675.2285894982576!2d-43.2093!3d-22.9068!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x997e58a085b7af%3A0x4d11e9a933d38ce3!2sRio%20de%20Janeiro%2C%20Brazil!5e0!3m2!1sen!2skr!4v1234567890',
        imageQuery: 'rio carnival brazil',
        fallbackImage: 'https://images.unsplash.com/photo-1516450137517-162bfbeb8dba?w=800',
        attractions: [
            {
                name: 'ì‚¼ë°”ë“œë¡¬ í¼ë ˆì´ë“œ',
                description: 'í™”ë ¤í•œ ì‚¼ë°” í•™êµë“¤ì˜ ê²½ì—°',
                image: 'https://images.unsplash.com/photo-1516450137517-162bfbeb8dba?w=600'
            },
            {
                name: 'ì½”ë¥´ì½”ë°”ë„ ì˜ˆìˆ˜ìƒ',
                description: 'ë¦¬ìš°ì˜ ìƒì§•ì ì¸ ëœë“œë§ˆí¬',
                image: 'https://images.unsplash.com/photo-1483729558449-99ef09a8c325?w=600'
            },
            {
                name: 'ì½”íŒŒì¹´ë°”ë‚˜ í•´ë³€',
                description: 'ì„¸ê³„ì ìœ¼ë¡œ ìœ ëª…í•œ í•´ë³€',
                image: 'https://images.unsplash.com/photo-1516306580123-e6e52b1b7b5f?w=600'
            }
        ],
        budget: {
            'í•­ê³µê¶Œ': 1500000,
            'ìˆ™ë°•': 800000,
            'ì‹ì‚¬': 500000,
            'ì…ì¥ë£Œ': 400000,
            'êµí†µ': 200000,
            'ê¸°íƒ€': 100000
        },
        tips: {
            ì¤€ë¹„ë¬¼: ['ê°€ë²¼ìš´ ì—¬ë¦„ì˜·', 'ì„ í¬ë¦¼', 'ëª¨ì', 'ì¹´ë©”ë¼'],
            ì£¼ì˜ì‚¬í•­: ['ì†Œë§¤ì¹˜ê¸° ì£¼ì˜', 'ê·€ì¤‘í’ˆ ìµœì†Œ ì†Œì§€', 'ìˆ˜ë¶„ ë³´ì¶©'],
            ì¶”ì²œ: ['ê±°ë¦¬ íŒŒí‹° ì°¸ê°€', 'ì‚¼ë°” ì˜ìƒ ì²´í—˜', 'í•´ë³€ ì‚°ì±…']
        },
        packageDetails: {
            included: [
                'ì™•ë³µ í•­ê³µê¶Œ (ì¸ì²œ-ìƒíŒŒìš¸ë£¨-ë¦¬ìš°, ì´ì½”ë…¸ë¯¸ì„)',
                '4ì„±ê¸‰ í˜¸í…” 6ë°• (ì¡°ì‹ í¬í•¨)',
                'ì¹´ë‹ˆë°œ í¼ë ˆì´ë“œ ì§€ì •ì„ ì…ì¥ê¶Œ',
                'ì‚¼ë°”ë“œë¡¬ VIP êµ¬ì—­ 2ì¼ê¶Œ',
                'ì½”ë¥´ì½”ë°”ë„ ì˜ˆìˆ˜ìƒ íˆ¬ì–´',
                'ìŠˆê°€ë¡œí”„ ë§ˆìš´í‹´ ì¼€ì´ë¸”ì¹´',
                'ì´íŒŒë„¤ë§ˆ ë¹„ì¹˜ ì„ ì…‹ í¬ë£¨ì¦ˆ',
                'ì—¬í–‰ì ë³´í—˜',
                'í•œêµ­ì¸ ê°€ì´ë“œ'
            ],
            excluded: [
                'ê°œì¸ ê²½ë¹„ ë° ì‡¼í•‘ ë¹„ìš©',
                'ì„ íƒ ê´€ê´‘ í”„ë¡œê·¸ë¨',
                'ì¶”ê°€ ì‹ì‚¬ ë° ìŒë£Œ',
                'ì¹´ë‹ˆë°œ ì˜ìƒ ëŒ€ì—¬',
                'í˜¸í…” ë¯¸ë‹ˆë°”',
                'ì—¬ê¶Œ ë° ë¹„ì ë°œê¸‰ ë¹„ìš©'
            ],
            productCode: 'FEST-BR-003',
            departureDates: [
                '2026ë…„ 2ì›” 12ì¼ (ëª©)',
                '2026ë…„ 2ì›” 14ì¼ (í† )',
                '2026ë…„ 2ì›” 16ì¼ (ì›”)'
            ],
            groupDiscount: {
                '4-6ëª…': '1ì¸ë‹¹ 70,000ì› í• ì¸',
                '7-9ëª…': '1ì¸ë‹¹ 100,000ì› í• ì¸',
                '10ëª… ì´ìƒ': '1ì¸ë‹¹ 150,000ì› í• ì¸'
            }
        }
    }
};

// ===== ì‹œì¥ ë¶„ì„ ë°ì´í„° =====
const marketAnalysis = {
    developmentReason: {
        trends: [
            {
                icon: 'fa-chart-line',
                title: 'ì²´í—˜í˜• ê´€ê´‘ ìˆ˜ìš” ì¦ê°€',
                description: 'MZì„¸ëŒ€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ SNS ì¸ì¦ìƒ·, íŠ¹ë³„í•œ ê²½í—˜ì„ ì¤‘ì‹œí•˜ëŠ” ì²´í—˜í˜• ê´€ê´‘ ìˆ˜ìš”ê°€ ì—°í‰ê·  25% ì¦ê°€'
            },
            {
                icon: 'fa-users',
                title: 'íƒ€ê²Ÿì¸µ ëª…í™•í•œ ë‹ˆì¹˜ ì‹œì¥',
                description: 'ì¶•ì œ ì¤‘ì‹¬ íŒ¨í‚¤ì§€ëŠ” 20-40ëŒ€ ì Šì€ì¸µì˜ êµ¬ë§¤ë ¥ê³¼ ì—¬í–‰ ì„ í˜¸ë„ê°€ ë†’ì•„ íš¨ê³¼ì ì¸ ë§ˆì¼€íŒ… ê°€ëŠ¥'
            },
            {
                icon: 'fa-globe',
                title: 'ì°¨ë³„í™”ëœ ìƒí’ˆ ê²½ìŸë ¥',
                description: 'ì¼ë°˜ ìœ ëŸ½/ë‚¨ë¯¸ íŒ¨í‚¤ì§€ì™€ ë‹¬ë¦¬ ì¶•ì œ ì‹œì¦Œì— ë§ì¶˜ í…Œë§ˆ ìƒí’ˆìœ¼ë¡œ ë†’ì€ í”„ë¦¬ë¯¸ì—„ ê°€ê²© ì±…ì • ê°€ëŠ¥'
            },
            {
                icon: 'fa-calendar-check',
                title: 'ì‹œì¦Œì„± í™œìš© ìˆ˜ìµ ê·¹ëŒ€í™”',
                description: 'ì¶•ì œ íŠ¹ì • ê¸°ê°„ì— ì§‘ì¤‘ íŒë§¤ë¡œ ì„±ìˆ˜ê¸° ë§¤ì¶œ í™•ë³´ ë° ì—°ê°„ ë§¤ì¶œ ì•ˆì •í™”'
            }
        ],
        targetCustomers: [
            {
                segment: 'ì£¼ íƒ€ê²Ÿ: ëŒ€í•™ìƒ ë° ì§ì¥ ì´ˆë…„ìƒ (20-30ëŒ€)',
                size: '50ë§Œëª…',
                spending: '250ë§Œì›',
                reason: 'SNS í™œë™ í™œë°œ, ìƒˆë¡œìš´ ê²½í—˜ ì¶”êµ¬, ì¹œêµ¬ë“¤ê³¼ì˜ ì¶”ì–µ ë§Œë“¤ê¸° ì¤‘ì‹œ'
            },
            {
                segment: 'ë¶€ íƒ€ê²Ÿ: ì§ì¥ì¸ ë° ì‹ í˜¼ë¶€ë¶€ (30-40ëŒ€)',
                size: '30ë§Œëª…',
                spending: '350ë§Œì›',
                reason: 'ì—¬ìœ ë¡œìš´ ì†Œë“, í’ˆì§ˆ ì¤‘ì‹œ, ë¬¸í™”ì²´í—˜ ì„ í˜¸'
            }
        ]
    },
    profitability: {
        tomatina: {
            sellingPrice: 2200000,
            fixedCost: 500000,
            variableCost: 1390000,
            totalCost: 1890000,
            margin: 0.141,
            breakEven: 15,
            expectedCustomers: 120,
            annualRevenue: 37200000
        },
        oktoberfest: {
            sellingPrice: 2800000,
            fixedCost: 600000,
            variableCost: 1720000,
            totalCost: 2320000,
            margin: 0.171,
            breakEven: 12,
            expectedCustomers: 180,
            annualRevenue: 86400000
        },
        carnival: {
            sellingPrice: 3500000,
            fixedCost: 800000,
            variableCost: 2420000,
            totalCost: 3220000,
            margin: 0.223,
            breakEven: 10,
            expectedCustomers: 105,
            annualRevenue: 81900000
        }
    }
};

// ===== ê¸°ëŒ€ íš¨ê³¼ ë°ì´í„° =====
const expectedEffects = {
    financial: {
        year1: {
            revenue: 1140000000,
            profit: 210000000,
            margin: 0.181
        },
        year2Growth: 0.30,
        year3Growth: 0.50
    },
    marketing: {
        brandBuilding: 'ì¶•ì œ ì „ë¬¸ ì—¬í–‰ì‚¬ ë¸Œëœë“œ êµ¬ì¶•',
        returnRate: 0.40,
        viral: 'SNS ë°”ì´ëŸ´ ë§ˆì¼€íŒ… íš¨ê³¼',
        partnership: 'ì—¬í–‰ ë§¤ì²´ ë° ë¸”ë¡œê±° í˜‘ì—…'
    },
    strategic: {
        expansion: 'ê³„ì ˆë³„ ìƒí’ˆ ë¼ì¸ì—… í™•ëŒ€',
        b2b: 'ëŒ€í•™êµ/ê¸°ì—… ë‹¨ì²´ ì—¬í–‰ ìˆ˜ì£¼',
        asiaExpansion: 'ì•„ì‹œì•„ ì¶•ì œ í™•ì¥ ê³„íš',
        partnership: 'í˜„ì§€ ì¥ê¸° íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶•'
    }
};

// ===== í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ‰ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ!');
    console.log('festivalsData:', Object.keys(festivalsData));
    loadFestivalCards();
    setupModalHandlers();
    console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ!');
});

// ===== ì¶•ì œ ì¹´ë“œ ë¡œë”© =====
async function loadFestivalCards() {
    console.log('ğŸ” ì¹´ë“œ ë¡œë”© ì‹œì‘...');
    const container = document.getElementById('festivalCards');
    
    if (!container) {
        console.error('âŒ festivalCards ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    console.log('âœ… ì»¨í…Œì´ë„ˆ ì°¾ìŒ:', container);
    container.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"></div></div>';

    try {
        // ë¨¼ì € ë¡œë”© ìŠ¤í”¼ë„ˆ ì œê±°
        container.innerHTML = '';
        
        let count = 0;
        for (const [key, festival] of Object.entries(festivalsData)) {
            console.log(`ğŸ“ ì¹´ë“œ ìƒì„± ì¤‘: ${festival.name}`);
            const imageUrl = await fetchUnsplashImage(festival.imageQuery, festival.fallbackImage);
            const card = createFestivalCard(festival, imageUrl);
            container.insertAdjacentHTML('beforeend', card);
            count++;
        }
        console.log(`âœ… ${count}ê°œ ì¹´ë“œ ìƒì„± ì™„ë£Œ!`);
    } catch (error) {
        console.error('âŒ ì¹´ë“œ ë¡œë”© ì—ëŸ¬:', error);
        container.innerHTML = '<div class="col-12 text-center text-danger">ì¶•ì œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
}

// ===== Unsplash ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° =====
async function fetchUnsplashImage(query, fallback) {
    try {
        // 3ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(
            `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1&client_id=${UNSPLASH_ACCESS_KEY}`,
            { signal: controller.signal }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error('API request failed');
        
        const data = await response.json();
        return data.results[0]?.urls?.regular || fallback;
    } catch (error) {
        console.log('âš ï¸ Unsplash API ì‹¤íŒ¨, fallback ì´ë¯¸ì§€ ì‚¬ìš©:', error.message);
        return fallback;
    }
}

// ===== ì¶•ì œ ì¹´ë“œ HTML ìƒì„± =====
function createFestivalCard(festival, imageUrl) {
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="festival-card" onclick="showFestivalDetail('${festival.id}')">
                <div class="festival-image" style="background-image: url('${imageUrl}')"></div>
                <div class="festival-content">
                    <h3>${festival.name}</h3>
                    <p class="festival-location">
                        <i class="fas fa-map-marker-alt"></i> ${festival.location}
                    </p>
                    <p class="festival-date">
                        <i class="fas fa-calendar"></i> ${festival.period}
                    </p>
                    <p class="festival-description">${festival.description}</p>
                    <div class="festival-footer">
                        <span class="festival-price">${festival.price}</span>
                        <button class="btn btn-primary btn-sm">ìì„¸íˆ ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ===== ëª¨ë‹¬ í•¸ë“¤ëŸ¬ ì„¤ì • =====
function setupModalHandlers() {
    const modal = document.getElementById('festivalModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì°¨íŠ¸ ì •ë¦¬
            if (window.budgetChart) {
                window.budgetChart.destroy();
                window.budgetChart = null;
            }
        });
    }
}

// ===== ì¶•ì œ ìƒì„¸ ì •ë³´ í‘œì‹œ =====
async function showFestivalDetail(festivalId) {
    console.log('ğŸ¯ í´ë¦­ë¨! ì¶•ì œ ID:', festivalId);
    const festival = festivalsData[festivalId];
    if (!festival) {
        console.error('âŒ ì¶•ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', festivalId);
        return;
    }
    console.log('âœ… ì¶•ì œ ì •ë³´:', festival.name);

    // ëª¨ë‹¬ ì œëª© ë° ê¸°ë³¸ ì •ë³´ ì„¤ì •
    document.getElementById('festivalModalLabel').textContent = festival.name;
    document.getElementById('detailPeriod').textContent = festival.period;
    document.getElementById('detailTarget').textContent = festival.target;
    document.getElementById('detailDescription').textContent = festival.description;

    // ì§€ë„ ì„¤ì •
    const mapContainer = document.getElementById('detailMap');
    mapContainer.innerHTML = `<iframe src="${festival.mapUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`;

    // ê´€ê´‘ì§€ ëª©ë¡ í‘œì‹œ
    displayAttractions(festival.attractions);

    // ê²½ë¹„ ì°¨íŠ¸ í‘œì‹œ
    displayBudgetChart(festival.budget, festival.price);

    // ì—¬í–‰ íŒ í‘œì‹œ
    displayTravelTips(festival.tips);

    // íŒ¨í‚¤ì§€ ì •ë³´ í‘œì‹œ
    if (festival.packageDetails) {
        displayPackageInfo(festival.packageDetails);
    }

    // ì†ìµë¶„ê¸°ì  ê³„ì‚° ë° í‘œì‹œ
    displayBreakEvenAnalysis(festivalId);

    // ëª¨ë‹¬ í‘œì‹œ
    const modal = new bootstrap.Modal(document.getElementById('festivalModal'));
    modal.show();
}

// ===== ê´€ê´‘ì§€ ëª©ë¡ í‘œì‹œ =====
function displayAttractions(attractions) {
    const container = document.getElementById('attractionsList');
    container.innerHTML = attractions.map(attraction => `
        <div class="col-md-4 mb-4">
            <div class="attraction-card">
                <img src="${attraction.image}" alt="${attraction.name}" class="attraction-image">
                <h4>${attraction.name}</h4>
                <p>${attraction.description}</p>
            </div>
        </div>
    `).join('');
}

// ===== ê²½ë¹„ ì°¨íŠ¸ í‘œì‹œ =====
function displayBudgetChart(budget, totalPrice) {
    const ctx = document.getElementById('budgetChart');
    if (!ctx) return;

    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
    if (window.budgetChart && typeof window.budgetChart.destroy === 'function') {
        window.budgetChart.destroy();
    }

    const labels = Object.keys(budget);
    const data = Object.values(budget);
    const colors = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe',
        '#43e97b', '#fa709a', '#fee140', '#30cfd0'
    ];

    window.budgetChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 15,
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return `${label}: â‚©${value.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });

    // ì´ ê²½ë¹„ í‘œì‹œ
    document.getElementById('totalBudget').textContent = totalPrice;
}

// ===== ì—¬í–‰ íŒ í‘œì‹œ =====
function displayTravelTips(tips) {
    document.getElementById('tipItems').innerHTML = tips.ì¤€ë¹„ë¬¼.map(item => 
        `<li><i class="fas fa-check"></i> ${item}</li>`
    ).join('');
    
    document.getElementById('tipWarnings').innerHTML = tips.ì£¼ì˜ì‚¬í•­.map(item => 
        `<li><i class="fas fa-exclamation-triangle"></i> ${item}</li>`
    ).join('');
    
    document.getElementById('tipRecommendations').innerHTML = tips.ì¶”ì²œ.map(item => 
        `<li><i class="fas fa-star"></i> ${item}</li>`
    ).join('');
}

// ===== íŒ¨í‚¤ì§€ ì •ë³´ í‘œì‹œ =====
function displayPackageInfo(packageDetails) {
    // í¬í•¨ ì‚¬í•­
    const includedList = document.getElementById('packageIncluded');
    if (includedList) {
        includedList.innerHTML = packageDetails.included.map(item => 
            `<li><i class="fas fa-check text-success"></i> ${item}</li>`
        ).join('');
    }
    
    // ë¶ˆí¬í•¨ ì‚¬í•­
    const excludedList = document.getElementById('packageExcluded');
    if (excludedList) {
        excludedList.innerHTML = packageDetails.excluded.map(item => 
            `<li><i class="fas fa-times text-danger"></i> ${item}</li>`
        ).join('');
    }
    
    // ì¶œë°œ ì¼ì •
    const datesList = document.getElementById('packageDates');
    if (datesList) {
        datesList.innerHTML = packageDetails.departureDates.map(date => 
            `<li><i class="fas fa-plane-departure text-info"></i> ${date}</li>`
        ).join('');
    }
    
    // ë‹¨ì²´ í• ì¸
    const discountDiv = document.getElementById('packageDiscount');
    if (discountDiv) {
        discountDiv.innerHTML = Object.entries(packageDetails.groupDiscount).map(([people, discount]) => 
            `<div class="discount-item">
                <span class="badge bg-warning text-dark">${people}</span> 
                <span class="text-success fw-bold">${discount}</span>
            </div>`
        ).join('');
    }
    
    // ìƒí’ˆ ì½”ë“œ
    const codeElement = document.getElementById('packageCode');
    if (codeElement) {
        codeElement.textContent = packageDetails.productCode;
    }
}

// ===== ì†ìµë¶„ê¸°ì  ë¶„ì„ í‘œì‹œ =====
function displayBreakEvenAnalysis(festivalId) {
    const profitData = marketAnalysis.profitability[festivalId];
    if (!profitData) return;

    const container = document.getElementById('breakEvenAnalysis');
    if (!container) return;

    const { fixedCost, variableCost, sellingPrice, breakEven, margin, expectedCustomers } = profitData;

    container.innerHTML = `
        <div class="info-card mt-3">
            <h3><i class="fas fa-calculator text-warning"></i> ì†ìµë¶„ê¸°ì  ë¶„ì„</h3>
            <div class="break-even-content">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="analysis-item">
                            <strong>ê³ ì •ë¹„:</strong>
                            <span class="text-primary">â‚©${fixedCost.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analysis-item">
                            <strong>1ì¸ë‹¹ ë³€ë™ë¹„:</strong>
                            <span class="text-primary">â‚©${variableCost.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="analysis-item">
                            <strong>íŒë§¤ê°€:</strong>
                            <span class="text-success">â‚©${sellingPrice.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analysis-item">
                            <strong>1ì¸ë‹¹ ê³µí—Œì´ìµ:</strong>
                            <span class="text-success">â‚©${(sellingPrice - variableCost).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mb-3">
                    <h5 class="mb-2"><i class="fas fa-info-circle"></i> ì†ìµë¶„ê¸°ì  ê³µì‹</h5>
                    <p class="mb-0">ì†ìµë¶„ê¸°ì  = ê³ ì •ë¹„ Ã· (íŒë§¤ê°€ - 1ì¸ë‹¹ ë³€ë™ë¹„)</p>
                    <p class="mb-0">= ${fixedCost.toLocaleString()} Ã· (${sellingPrice.toLocaleString()} - ${variableCost.toLocaleString()})</p>
                    <p class="mb-0">= ${fixedCost.toLocaleString()} Ã· ${(sellingPrice - variableCost).toLocaleString()}</p>
                </div>
                <div class="alert alert-success">
                    <h4 class="mb-2">
                        <i class="fas fa-chart-line"></i> 
                        ìµœì†Œ ëª¨ê° ì¸ì›: <strong>${breakEven}ëª…</strong>
                    </h4>
                    <p class="mb-2">ì˜ˆìƒ ëª¨ê°: <strong>${expectedCustomers}ëª…</strong></p>
                    <p class="mb-0">ë§ˆì§„ìœ¨: <strong>${(margin * 100).toFixed(1)}%</strong></p>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: ${(breakEven / expectedCustomers * 100)}%"
                         aria-valuenow="${breakEven}" aria-valuemin="0" aria-valuemax="${expectedCustomers}">
                        ì†ìµë¶„ê¸° ${breakEven}ëª…
                    </div>
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: ${((expectedCustomers - breakEven) / expectedCustomers * 100)}%"
                         aria-valuenow="${expectedCustomers - breakEven}" aria-valuemin="0" aria-valuemax="${expectedCustomers}">
                        ìˆ˜ìµêµ¬ê°„ ${expectedCustomers - breakEven}ëª…
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">
                    * ${breakEven}ëª… ì´ìƒ ëª¨ê° ì‹œ ìˆ˜ìµ ë°œìƒ, ${expectedCustomers}ëª… ëª¨ê° ëª©í‘œ
                </small>
            </div>
        </div>
    `;
}
